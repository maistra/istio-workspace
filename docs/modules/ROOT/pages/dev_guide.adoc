= Development Guide

== Release

=== Preparation

Before cutting the release we should prepare notes about its content. Assuming you are releasing `v0.0.2`, these are the steps you should perform:

. Draft highlights of the release (most notable features etc.). Use the template `docs/modules/ROOT/pages/release_notes/release_notes_template.adoc`
. Name the release notes file the same as new version and put it in `docs/modules/ROOT/pages/release_notes/v0.0.2.adoc` folder
. Create new branch called `release_v0.0.2`
. Open Pull Request so we can review the announcement and other related changes

Once the PR is approved you can perform additional steps by invoking `scripts/release.sh` as follows:

[source,bash]
----
./scripts/release.sh -v v0.0.2
----

This will validate if above steps were correctly performed and create two commits:

. `release: v0.0.2`
  * in this commit autogenerated changelog will be appended to release notes
  * the version in `docs/antora.yml` will be changed to a matching version
  * release notes will be prepended to `docs/modules/ROOT/pages/release_notes.adoc`
. `release: next iteration`
  * reverts version-related changes from previous commit

IMPORTANT: Using `--do-release` flag will result in pushing release commits to remote.

=== Triggering release process

After Pull Request with release notes is **rebased** on master we can trigger automated release process. 

In order to do that we have to tag release commit and push it to remote.

[source,bash]
----
git tag -a "${version}" $(git log --pretty=format:"%H" --grep="release: ${version}")
git push --tags
----

Such tagged commit triggers a CI job which will:

. build and push tagged docker image to `quay.io` registry
. push cross-compiled binaries and release notes to GitHub

Diagram below describes the entire process and its artifacts.

.Release automation
image::diagrams/automation-release.svg[Release automation]
// Source: https://drive.google.com/file/d/1m0r9AH3LntqgZ5K_IuF6KVcz5QGF2XhX/view?usp=sharing through draw.io
