name: Clean up images from PR testing
on:
  pull_request:
    types: closed

jobs:
  cleanup-images:
    name: quay-image-cleanup
    runs-on: ubuntu-latest
    steps:
      - name: Delete PR-related images
        env:
          QUAY_OAUTH_TOKEN: ${{ secrets.QUAY_OAUTH_TOKEN }}
          REPOSITORY: "https://quay.io/api/v1/repository/maistra"
          TAG: "PR-${{ github.event.number }}"
        run: |
          HEADER_TOKEN="Authorization: Bearer ${QUAY_OAUTH_TOKEN}"

          declare -a tags=("${TAG}-prow" "${TAG}-circle")
          for t in "${tags[@]}"
          do
             curl -H "${HEADER_TOKEN}" -X DELETE ${REPOSITORY}/istio-workspace/tag/${t}
             curl -H "${HEADER_TOKEN}" -X DELETE ${REPOSITORY}/istio-workspace-operator-bundle/tag/${t}
             curl -H "${HEADER_TOKEN}" -X DELETE ${REPOSITORY}/istio-workspace-test/tag/${t}
             curl -H "${HEADER_TOKEN}" -X DELETE ${REPOSITORY}/istio-workspace-test-prepared-image-prepared/tag/${t}
             curl -H "${HEADER_TOKEN}" -X DELETE ${REPOSITORY}/istio-workspace-test-prepared-prepared-image/tag/${t}
          done

        shell: bash
