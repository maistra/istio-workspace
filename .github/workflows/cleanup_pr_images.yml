name: Clean up images from PR testing
on:
  pull_request:
    types: closed

jobs:
  cleanup-images:
    name: quay-image-cleanup
    runs-on: ubuntu-latest
    steps:
      - name: Delete PR-related images
        env:
          QUAY_OAUTH_TOKEN: ${{ secrets.QUAY_OAUTH_TOKEN }}
          REPOSITORY: "https://quay.io/api/v1/repository/maistra"
          TAG: "PR-${{ github.event.number }}"
        run: |
          HEADER_TOKEN="Authorization: Bearer ${QUAY_OAUTH_TOKEN}"
          curl -H "${HEADER_TOKEN}" -X DELETE ${REPOSITORY}/istio-workspace/tag/${TAG}
          curl -H "${HEADER_TOKEN}" -X DELETE ${REPOSITORY}/istio-workspace-test/tag/${TAG}
          curl -H "${HEADER_TOKEN}" -X DELETE ${REPOSITORY}/istio-workspace-test-prepared-image-prepared/tag/${TAG}
          curl -H "${HEADER_TOKEN}" -X DELETE ${REPOSITORY}/istio-workspace-test-prepared-prepared-image/tag/${TAG}
        shell: bash
